#!/bin/bash

release=$(awk -F'"' '/fuel_version:/ {print $2}' /etc/astute.yaml)
cd /tmp
mkdir md5_${release} &> /dev/null
cd md5_${release}
tar -xf ../md5_${release}.tar.gz
dpkg-query -W -f '${Package}\t${Version}\n' | while read pkg
do
  id=$(grep "$pkg" ../versions.tsv | awk '{print $1}')
  ls ${id}_${release}_* &> /dev/null
  if [ "$?" -eq 0 ]
  then
    pushd / &> /dev/null
    result="$(md5sum --quiet -c /tmp/md5_${release}/${id}_${release}_*)"
    if [ "$?" -ne 0 ]
    then
      echo "$result" | grep -v 'did NOT match' | sed "s!^!${id}\t${pkg}\t!"
    fi
    popd &> /dev/null
  fi 
done
rm -r /tmp/md5_${release}
