#!/bin/bash

dpkg-query -W -f='${Package}\t${Version}\n' | while read l
do
  pkg=$(echo "$l" | cut -f1)
  if [ -f "/var/lib/dpkg/info/${pkg}:amd64.md5sums" ]
  then
    result=$(cd /; nice -n 19 ionice -c 3 md5sum --quiet -c /var/lib/dpkg/info/${pkg}:amd64.md5sums 2>&1)
  else
    result=$(cd /; nice -n 19 ionice -c 3 md5sum --quiet -c /var/lib/dpkg/info/${pkg}.md5sums 2>&1)
  fi
  if [ "$?" -ne 0 ]
  then
    if [ "$(echo $result | grep md5sums | grep -c 'No such file')" -gt 0 ]
    then
      :
      #cannot verify md5sum
    else
      echo "$result" | grep -v 'did NOT match\|md5sum: ' | sed "s/^/${l}\t/"
    fi
  fi
done
